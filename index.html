<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Libros</title>
    <!-- Importamos BootsTrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
</head>
<body>
    <div class="container-fluid">
        <header>
            <h1 class="text-center p-3 text-white bg-primary bg-gradient rounded-bottom-1"> Gestión de libros </h1>
        </header>
        <main>
            <!-- Contenedor principal en el que separa el formulario de la tabla -->
            <div class="row text-center gap-2 justify-content-center">
                <!-- Establecemos el formulario y le asignamos distintos tamaños de columna en funcion del ancho de la pantalla-->
                <div class="col-12 col-md-12 col-lg-3 col-xxl-3 border mx-4 p-3 border-primary-subtle rounded shadow overflow-y-auto" style="max-height: 600px;">
                    <!-- Contenedor para el folumalario -->
                    <div class="d-flex flex-column mb-3">
                        <div>
                            <h2>Añadir Libros</h2>
                            <!-- Estilo de formulario que pone los label dentro del input -->
                            <div class="form-floating m-3 shadow-sm">
                                <input type="text" class="form-control" id="titulo" placeholder="Titulo">
                                <label for="titulo">Titulo de Libro</label>
                            </div>
                            <div class="form-floating m-3 shadow-sm">
                                <input type="text" class="form-control" id="autor" placeholder="autor">
                                <label for="autor">Autor del Libro</label>
                            </div>
                            <div class="form-floating m-3 shadow-sm">
                                <input type="number" class="form-control" id="anoPublicacion" placeholder="anoPublicacion">
                                <label for="anoPublicacion">Año Publicación</label>
                            </div>
                            <div class="form-check-center form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="disponible" checked>
                                <label class="form-check-label" for="disponible">Disponible</label>
                            </div>
                        </div>
                        <div class="mt-4">
                            <button type="button" class="btn btn-success m-1" id="guardarLibro">Guardar Libro</button>
                            <button type="button" class="btn btn-warning m-1" id="exportarXML" onclick="descargarXML()">Exportar XML</button>
                            <button type="button" class="btn btn-info m-1" id="exportarXML" onclick="limpiarFormulario()">Limpiar Formulario</button>
                            <div class="mb-3">
                                <label for="formFile" class="form-label"></label>
                                <input class="form-control form-control-sm" type="file" id="fileImportarXML">
                                <button type="button" class="btn btn-danger mt-4" id="importarXML" onclick="importarXML()">Importar XML</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-12 col-lg-6 col-xxl-8 border mx-4 p-3 border-primary-subtle rounded shadow overflow-y-auto" style="max-height: 600px;">
                    <h2>Inventario</h2>
                    <form class="d-flex" role="search">
                        <input class="form-control me-2 shadow-sm" type="search" placeholder="Búsqueda por título" aria-label="Search" id="buscadorTabla">
                    </form>
                    <table class="table table-striped table-hover table-info mt-4 shadow">
                        <thead >
                            <th>#</th>
                            <th>Titulo</th>
                            <th>Autor</th>
                            <th>Año</th>
                            <th>Disponible</th>
                            <th>Gestión</th>
                        </thead>
                        <tbody class="table-group-divider" id="tablaLibros">

                        </tbody>
                    </table>
                </div>
            </div>
        </main>
        <footer class="position-fixed bottom-0 start-0 w-100 text-center p-2 text-bg-primary">
            <div>
                <a class="icon-link icon-link-hover link-light" href="https://www.linkedin.com/in/roberto-izquierdo-gomez/">
                    <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-linkedin" viewBox="0 0 16 16">
                        <path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854zm4.943 12.248V6.169H2.542v7.225zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248S2.4 3.226 2.4 3.934c0 .694.521 1.248 1.327 1.248zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016l.016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225z"/>
                    </svg>
                    LinkedIn
                </a>
                    <a class="icon-link icon-link-hover link-light" href="https://github.com/RobertoIzquierdoGomez" target="_blank" rel="noopener">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-github" viewBox="0 0 16 16">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8"/>
                    </svg>
                    GitHub
                </a>
            </div>
            <div>
                &copy; 2025 - Roberto Izquierdo Gomez
            </div>
        </footer>
    </div>
    <script>

        let libros = JSON.parse(localStorage.getItem("libros")) || [];

        window.onload = () => {
            actualizarTabla();
        };

        //Funcion con un query selector y un event listener para cuando pulses el boton guardarlibro se añada a la tabla
        document.querySelector("#guardarLibro").addEventListener("click", function(){
            let titulo = document.querySelector("#titulo").value.trim();
            let autor = document.querySelector("#autor").value.trim();
            let anoPublicacion = document.querySelector("#anoPublicacion").value;
            let disponible = document.querySelector('#disponible').checked ? "Si" : "No";

            if(titulo === "" || autor === "" || anoPublicacion === ""){
                alert("Por favor, tienes que rellenar todos los campos")
                return;
            }

            let libro = {
                titulo: titulo,
                autor: autor,
                anoPublicacion: anoPublicacion,
                disponible: disponible
            }

            libros.push(libro);
            guardarLocalStorage();
            actualizarTabla();
            limpiarFormulario();

        })

        //Función para agregar los datos del libro
        function actualizarTabla(){

            let tabla = document.getElementById("tablaLibros");
            tabla.innerHTML = "";

            libros.forEach((libro, index) => {

                let fila = `
                <tr >
                    <td style="font-weight: bold;">${index+1}</td>
                    <td>${libro.titulo}</td>
                    <td>${libro.autor}</td>
                    <td>${libro.anoPublicacion}</td>
                    <td>${libro.disponible}</td>
                    <td><button type="button" class="btn btn-danger" id="importarXML" onclick="eliminarLibro(${index})">Eliminar</button></td>
                </tr>
                `;
                tabla.innerHTML += fila;
            });
        }

        function limpiarFormulario(){
            document.getElementById("titulo").value = "";
            document.getElementById("autor").value = "";
            document.getElementById("anoPublicacion").value = "";
        }

        function guardarLocalStorage(){
            localStorage.setItem("libros", JSON.stringify(libros));
        }

        function eliminarLibro(index){
            libros.splice(index,1);
            guardarLocalStorage();
            actualizarTabla();
        }


        function descargarXML(){
            // Se inicia una cadena XML con la declaración estándar y la etiqueta raíz <libros>
            let xml = '<?xml version="1.0" encoding="UTF-8"?> ';
            xml += '<libros>';

            // Se recorre el array libros, y por cada objeto en él...
            libros.forEach(p => {
                // ...se agrega una etiqueta <libro> con los datos individuales como elementos hijo
                xml += `<libro>
                    <titulo>${p.titulo}</titulo>
                    <autor>${p.autor}</autor>
                    <anoPublicacion>${p.anoPublicacion}</anoPublicacion>
                    <disponible>${p.disponible}</disponible>
                </libro>` 
            }); 

            // Se cierra la etiqueta raíz </libros>
            xml += '</libros>'; 

            // Se crea un objeto Blob con el contenido XML y el tipo MIME correspondiente
            const blob = new Blob([xml], { type: "application/xml" });

            // Se crea un elemento <a> dinámicamente para descargar el archivo
            const a = document.createElement("a");
            // Se crea una URL temporal que apunta al Blob
            a.href = URL.createObjectURL(blob);
            // Se define el nombre del archivo que se descargará
            a.download = "libros.xml";

            // Se simula un clic en el enlace para iniciar la descarga
            a.click();
        }


        function importarXML(){ //El event es un parametro de entrada que coge todas las caracteristicas del fileInput
            const file = document.getElementById("fileImportarXML").files[0];

            if(!file){
                return;
            }

            const reader = new FileReader();
            reader.readAsText(file);
            //asincronia en terminos generales es cuando necesitas que el sistema espera para alinearse con el resto de cosas. Es decir, aqui estamos pidiendo que hasta que no lea todo el fichero no pase al resto de codigo.
            reader.onload = function(e){

                const xmlString = e.target.result; //Almacenamos el contenido
                const parser = new DOMParser(); //Utilizamos la clase para poder transformar el string a un vector
                //Se usa application por que vas a implementarle una logica (aplicacion). Si vas a usar para por ejemplo enseñarlo en consola usar txt/xml (vas a enseñar el texto)
                const xmlDoc = parser.parseFromString(xmlString,"application/xml"); //Se indica el string y el tipo de archivo
                const libros2 = xmlDoc.getElementsByTagName("libro"); //Se utiliza el DOMParser y se indica que la tarjeta libro diferencia cada parte del vector.

                libros = [];

                
                for(let i = 0; i < libros2.length; i++){
                    const p = libros2[i];
                    let titulo = p.getElementsByTagName("titulo")[0]?.textContent || "";
                    let autor = p.getElementsByTagName("autor")[0]?.textContent || "";
                    let anoPublicacion = p.getElementsByTagName("anoPublicacion")[0]?.textContent || "";
                    let disponible = p.getElementsByTagName("disponible")[0]?.textContent || "";

                    libros.push({titulo, autor, anoPublicacion, disponible});

                };

                guardarLocalStorage();
                actualizarTabla();
                alert("Datos cargados");
            }
        };

        //Función para el buscador
        document.getElementById("buscadorTabla").addEventListener("input", function () {

            let tabla = document.getElementById("tablaLibros");
            let buscador = document.getElementById("buscadorTabla").value.trim().toLowerCase();

            // Limpiar el contenido actual de la tabla
            tabla.innerHTML = "";

            libros.forEach((libro, index) => {
                if (libro.titulo.toLowerCase().includes(buscador)) {
                    let fila = `
                        <tr>
                            <td style="font-weight: bold;">${index + 1}</td>
                            <td>${libro.titulo}</td>
                            <td>${libro.autor}</td>
                            <td>${libro.anoPublicacion}</td>
                            <td>${libro.disponible}</td>
                            <td><button type="button" class="btn btn-danger" onclick="eliminarLibro(${index})">Eliminar</button></td>
                        </tr>
                    `;
                    tabla.innerHTML += fila;
                }
            });
        });


    </script>
</body>
</html>



